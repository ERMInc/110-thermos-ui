<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Network optimisation formulation</title>
<meta name="generator" content="Org mode" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Network optimisation formulation</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org449ef11">1. Overview</a></li>
<li><a href="#orgce16ad2">2. Problem preparation</a>
<ul>
<li><a href="#orgc51cfdc">2.1. Conversion to present values</a></li>
<li><a href="#orgddd33f4">2.2. Flow bounds</a></li>
<li><a href="#org4f7c283">2.3. Linearised pipe costs</a></li>
<li><a href="#org0cee014">2.4. Tidying up</a></li>
</ul>
</li>
<li><a href="#org99819f1">3. Mixed-integer linear formulation</a>
<ul>
<li><a href="#org36e5ad0">3.1. Sketch</a></li>
<li><a href="#org70201e7">3.2. Formalism</a></li>
<li><a href="#orgbd9a0d0">3.3. Insulation</a></li>
<li><a href="#org1aa4c50">3.4. Individual systems</a></li>
</ul>
</li>
<li><a href="#org6e117cb">4. Parameter updates</a>
<ul>
<li><a href="#org192093f">4.1. Finding diversity factors</a>
<ul>
<li><a href="#orge44a867">4.1.1. Preventing invalid configurations</a></li>
<li><a href="#orged4a0cc">4.1.2. Initial diversity factors</a></li>
</ul>
</li>
<li><a href="#org2080e4f">4.2. Finding heat losses</a>
<ul>
<li><a href="#org82b5da4">4.2.1. Initial heat losses</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3378a3d">5. Solution re-evaluation</a></li>
<li><a href="#org1f730a8">6. Choices of objective</a>
<ul>
<li><a href="#orgd6d12c1">6.1. Market tariff</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
The THERMOS network optimisation is a heuristic centred around a mixed integer/linear programming approach<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>.
</p>

<div id="outline-container-org449ef11" class="outline-2">
<h2 id="org449ef11"><span class="section-number-2">1</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
The THERMOS network optimisation process works in a few steps:
</p>

<ol class="org-ol">
<li><p>
Problem preparation.
</p>

<p>
The representation of the problem used for the editor is converted into a form suitable for the optimiser.
</p>

<p>
This means:
</p>

<ol class="org-ol">
<li>Making all the different objective contributions commensurable, by converting them into present values or costs</li>
<li>Computing upper and lower bounds for the size and diversity for all pipe segments</li>
<li>Generating linearised pipe cost functions for all pipe segments</li>
<li>Tidying up the network to remove areas which cannot be connected and to combine pipe segments which contain redundant junctions</li>
</ol></li>

<li><p>
Mixed-integer linear formulation and solving.
</p>

<p>
Once the first step is done THERMOS phrases the problem as a mixed integer/linear program (MILP), and hands it off to a solver package to find a solution.
</p></li>

<li><p>
Parameter update loop.
</p>

<p>
Heat losses and diversity factors cannot be decided as part of the MILP, and depend on the structure of the proposed network.
</p>

<p>
Once we have a solution, we re-evaluate the heat losses and diversity factors. 
Unfortunately this implies that the MILP we solved was not quite the correct one, so we solve it again with the new parameters and see whether this changes the result.
</p>

<p>
If the result is unaffected, or we are going in circles, or we have run out of time, we stop.
</p></li>

<li><p>
Best solution re-evaluation.
</p>

<p>
Finally, we take the best solution we encountered in the parameter update loop and re-evaluate it using the nonlinear pipe cost functions; this again breaks the optimality guarantee from the MILP, but using the full nonlinear cost shapes makes the problem too hard.
</p></li>
</ol>
</div>
</div>

<div id="outline-container-orgce16ad2" class="outline-2">
<h2 id="orgce16ad2"><span class="section-number-2">2</span> Problem preparation</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgc51cfdc" class="outline-3">
<h3 id="orgc51cfdc"><span class="section-number-3">2.1</span> Conversion to present values</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The MILP does not contain any representation of time, except for a distinction between peak and average operating conditions.
</p>

<p>
Because of this ongoing revenues and costs have to be summed up over the whole accounting period.
</p>

<p>
In general, any cost or revenue is converted into a time-series of payments spanning the accounting period. These payments are then discounted and summed in the normal way to give a present value:
</p>

<p>
\[
\mathit{PV}(x, r) = \sum_i x_i / (1 + r)^i
\]
</p>

<p>
Capital costs are converted into a time-series in one of two ways, which can be combined:
</p>

<ul class="org-ul">
<li>By repetition on some interval</li>
<li><p>
By annualizing the cost with a loan:
</p>

<p>
\[
  \frac{X×r}{1 - 1/((1+r)^t)}
  \]
</p></li>
</ul>

<p>
There are four combinations possible here:
</p>

<ul class="org-ul">
<li>No repetition or loan</li>
<li>Repetition without a loan</li>
<li>A loan without repetition</li>
<li>Both a loan and repetition</li>
</ul>

<p>
Some costs depend on decisions made by the optimiser. 
</p>

<p>
For example, the cost of a heat supply is framed in terms of its capacity, which we do not know up-front.
</p>

<p>
In these cases, the <i>unit</i> cost is what is converted to a present value. 
Fortunately, geometric discounting is safe to apply to the unit rate, so the present value of the unit cost multiplied with the size is equal to the present value of the size multiplied with the unit cost:
</p>

<p>
\[
PV(\text{unit rate}) \times \text{size} = PV(\text{unit rate} \times \text{size})
\]
</p>
</div>
</div>

<div id="outline-container-orgddd33f4" class="outline-3">
<h3 id="orgddd33f4"><span class="section-number-3">2.2</span> Flow bounds</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The formulation of the MILP involves so-called "big-M" constraints (of which more later), and the use of linearised pipe costs. 
</p>

<p>
To make both of these things work well, we need to have good <i>bounds</i> on the heat flow on each potential pipe segment. Producing tight bounds here makes the MILP easier to solve, and makes the linearised pipe cost function less erroneous.
</p>
</div>
</div>

<div id="outline-container-org4f7c283" class="outline-3">
<h3 id="org4f7c283"><span class="section-number-3">2.3</span> Linearised pipe costs</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Pipe costs are represented by equations of the form
</p>

<p>
\[
\text{length} \times (A + B \times (\oslash ^ {1.1}) + C \times (\oslash ^ {1.3}))
\]
</p>

<p>
However, the MILP works in terms of power, rather than diameter (it decides on the capacity for pipes in terms of power flow), so we must first convert this equation into one which relates a flow of heat to a cost. 
</p>

<p>
THERMOS does this using a relation between delivered power and diameter:
</p>

<p>
\[
p(d) = (-0.4834 + 4.7617 × (d ^ {0.3701})) \times \delta_t \times \rho \times c
\]
</p>

<p>
where \(d\) is the diameter, \(\delta_t\) the temperature difference,  \(\rho\) the density and \(c\) the specific heat capacity. This relation is an approximation; the real hydraulic behaviour is complicated and not modelled in THERMOS.
</p>

<p>
Anyhow, using this relation we are able to numerically generate a pipe cost function which relates kW of power to the pipe's cost per meter.
</p>

<p>
This function is non-linear, and also not monotonically increasing<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>, which makes it hard to efficiently approximate within a MILP. 
</p>

<p>
In THERMOS, we make a linear approximation to this function for each place where a pipe could go; the approximation's terms are chosen to minimise the square error resulting from using it. 
</p>

<p>
Because we have flow bounds for every potential pipe, we are able to restrict the range we are approximating to the range of powers that the pipe may be required to deliver, which also helps to keep the error down.
</p>
</div>
</div>

<div id="outline-container-org0cee014" class="outline-3">
<h3 id="org0cee014"><span class="section-number-3">2.4</span> Tidying up</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Finally we do a bit of tidying up to simplify the optimiser input, removing:
</p>

<ol class="org-ol">
<li>Buildings which can't be connected to any supply and have no alternative system possible</li>
<li>Paths which don't go to any building</li>
<li>Junctions in the road network which would have no effect on the result.
This combines any paths which can be combined.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org99819f1" class="outline-2">
<h2 id="org99819f1"><span class="section-number-2">3</span> Mixed-integer linear formulation</h2>
<div class="outline-text-2" id="text-3">
<p>
The result of the above process is a simplified problem description, containing the following information:
</p>

<ul class="org-ul">
<li>For each demand location:
<ul class="org-ul">
<li>Annual and peak demand</li>
<li>The number of demands, for diversity calculation</li>
<li>The present value of connecting the building, in three parts: a fixed part, a part per kWh and a part per kWp (kWp being peak demand)</li>
<li>The present value of connection costs for the building, split the same way.</li>
<li>A list of insulation that is available there, characterised by:
<ul class="org-ul">
<li>The present cost of the insulation, as a fixed cost and cost per kWh abated demand</li>
<li>The maximum and minimum values for kWh demand that can be abated</li>
</ul></li>
<li>A list of alternatives that are available there, characterised by:
<ul class="org-ul">
<li>Present cost, in terms of fixed cost, kWh cost and kWp cost</li>
<li>Emissions factors per kWh</li>
</ul></li>
</ul></li>
<li>For each supply location:
<ul class="org-ul">
<li>The maximum peak capacity available</li>
<li>The present cost of supply, in terms of a fixed cost, a cost per kWp, and a cost per kWh</li>
<li>Emissions factors per kWh</li>
</ul></li>
<li>For each possible path:
<ul class="org-ul">
<li>Upper bounds for the heat it might be asked to carry in any possible network, at peak and average time</li>
<li>The present cost of using the path, in terms of a fixed cost and a cost per kWp</li>
</ul></li>
<li>For each type of emission:
<ul class="org-ul">
<li>The present cost per tonne emitted</li>
<li>Any upper bound required</li>
</ul></li>
</ul>
</div>

<div id="outline-container-org36e5ad0" class="outline-3">
<h3 id="org36e5ad0"><span class="section-number-3">3.1</span> Sketch</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Before giving the formal description, here is a sketch of how the problem is defined; this should make the formalism a bit easier to read.
</p>

<p>
The task for the optimiser is to choose what to do with each demand (network or individual system), and what to do with each possible path (pipe or not, and what size).
</p>

<p>
So, there are decision variables for these choices:
</p>

<ul class="org-ul">
<li><p>
For every building, a decision about how to heat it and a decision about how much insulation to buy.
</p>

<p>
These are a series of binary variables - either a building is on a network or not, it has a gas boiler or not, it has external wall insulation or not, and so on. 
</p>

<p>
For insulation, there is also a continuous variable to be decided: how much insulation to buy.
</p></li>
<li><p>
For every arc (an arc being one of the two directions along a path), a decision about whether to use it and how big to make it.
</p>

<p>
So these are two variables, whether we buy the arc or not, and how big a pipe we put in.
</p></li>
</ul>

<p>
Given these decision variables it is possible to write down the objective function. 
For example we can say that if the connection of a building \(i\) to network is given by the variable \(DVIN_{i}\), then the objective function includes terms like \(DVIN_{i} \times \text{pv of connecting }i\).
</p>

<p>
Similarly for pipes we might say that \(AIN_{i,j}\) is 1 if a pipe from \(i\) to \(j\) is included and 0 otherwise, and \(CAPACITY_{i,j}\) is the size of the pipe needed in kWp. Then the cost of the pipe to the objective is \(AIN_{i,j} \times \text{fixed cost} + CAPACITY_{i,j} \times \text{variable cost}\).
</p>

<p>
To prevent the optimiser producing a silly result we also need a system of constraints that describe what a legal solution looks like. 
</p>

<p>
The detail of these is given below, but it mostly expresses a few simple rules:
</p>

<ul class="org-ul">
<li>At every point in the network, the flow of heat has to balance, so that if heat flows out into a building or junction it must be balanced by heat that flows in from a pipe or a supply location</li>
<li>Along every arc in the network, the pipe capacity must be enough to carry the flow of heat along that arc</li>
<li>At every demand location, there has to be a choice of exactly one type of heating used</li>
</ul>
</div>
</div>

<div id="outline-container-org70201e7" class="outline-3">
<h3 id="org70201e7"><span class="section-number-3">3.2</span> Formalism</h3>
<div class="outline-text-3" id="text-3-2">
<p>
First we should introduce some symbols for the mathematical formulation:
</p>

<ul class="org-ul">
<li>The set of all vertices (junctions or end-points in a network), called \(\mathit{VTX}\) and usually indexed by \(i\), having subsets:
<ul class="org-ul">
<li>The set of demand vertices \(\mathit{DVTX}\)</li>
<li>The set of supply vertices \(\mathit{SVTX}\),</li>
</ul></li>
<li>The set of all arcs (directed pipes in a network), called \(\mathit{ARC}\), which is \(\mathit{VTX} \times \mathit{VTX}\), usually indexed by \(a\) or \((i, j)\)</li>
<li>The set of all edges, called \(\mathit{EDGE}\), which is the undirected subset of \(\mathit{ARC}\), often indexed by \(e\).</li>
<li>The set of all individual system types, called \(\mathit{ALT}\), usually indexed by \(t\)</li>
<li>The set of insulation types, called \(\mathit{INS}\), usually indexed by \(t\)</li>
<li><p>
Two types of 'time', usually indexed by \(t\). 
</p>

<p>
The two times are t<sub>peak</sub> and t<sub>mean</sub>, which reflect peak and average / annual operating conditions for the network.
</p></li>
</ul>

<p>
In the code there are a few more sets, but they are implementation details best understood by reading the program. 
We don't explain them here, because it would make the design less clear.
</p>

<p>
Next we can consider the decision variables for the network part (we will cover individual systems and insulation a bit later):
</p>

<ul class="org-ul">
<li>\(\mathit{DVIN}_i\) is a binary variable (valued 0 or 1) which models which \(i\) in \(\mathit{DVTX}\) are on the heat network</li>
<li>\(\mathit{SVIN}_i\) is a binary variable which models which \(i\) in \(\mathit{SVTX}\) are providing heat to the network</li>
<li>\(\mathit{AIN}_{i,j}\) is a binary variable which models which arcs have a pipe on them</li>
<li>\(\mathit{FLOW}_{i,j,t}\) is is a nonnegative real value which models the flow of heat from \(i\) to \(j\) in time period \(t\)</li>
<li>\(\mathit{CAPACITY}_{i,j}\) is is a nonnegative real value which models the pipe size required (in kw) from \(i\) to \(j\) in any period, allowing for diversity (of which more later)</li>
<li>\(\mathit{SUPPLY}_{i,t}\) is a nonnegative real value which models the heat output from supply location \(i\) in time \(t\)</li>
<li>\(\mathit{SUPPLYCAPACITY}_{i}\) is a nonnegative real value which models the plant capacity required at location \(i\)</li>
</ul>

<p>
These variables produce contributions to objective in a fairly direct way:
</p>

<dl class="org-dl">
<dt>Revenues</dt><dd><p>
Since \(\mathit{DVIN}_i\) is 1 if a building is connected to the network, the revenue from a building is
\[
              \sum_i \mathit{DVIN}_i \times (\text{present value of connecting})
              \]
</p>

<p>
Ignoring insulation, the present value of connecting the building is a constant which we can work out outside the MILP. We will return to insulation later.
</p></dd>
<dt>Connection costs</dt><dd>Similarly to revenues, we can state the connection cost as 
\[
     \sum_i \mathit{DVIN}_i \times \text{present cost of connecting}
     \]</dd>
<dt>Heat cost</dt><dd>The cost of heat input into the network is 
\[
               \sum_{i \in \mathit{SVTX}} \mathit{SUPPLY}_{i, t_{mean}} \times \text{present cost per kwh}
               \]</dd>
<dt>Plant cost</dt><dd>The cost of plant is 
\[
                \sum_{i \in \mathit{SVTX}} \mathit{SVIN}_{i} \times \text{present fixed cost of supply at $i$} + \mathit{SUPPLYCAPACITY}_i \times \text{present variable cost of supply at $i$}
                \]</dd>
<dt>Pipe cost</dt><dd>The cost of pipes is quite similar to the cost of supplies: 
\[
               \sum_a \mathit{AIN}_a \times \text{fixed cost of $a$} + \mathit{CAPACITY}_a \times \text{variable cost of $a$}
               \]</dd>
</dl>

<p>
However we must also bind the optimiser to produce a sensible answer using some constraints:
</p>

<dl class="org-dl">
<dt>Flow balances</dt><dd><p>
The flow balance rule is what makes the model build a network at all.
For every point \(i\) at each "time" \(t\) (which includes all supply points, demand points, and junctions between paths), we define the <i>unmet demand</i> at \(i\) in \(t\) as the difference between all the heat leaving \(i\) and all the heat flowing into \(i\).
</p>

<p>
In formal terms, this the unmet demand at \(i\) in time \(t\) is
</p>

<p>
\[
                   u = (\mathit{demand} + \mathit{outflow} + \mathit{losses}_{}) - (\mathit{supply} + \mathit{inflow})
                   \]
</p>

<p>
where we use \(\mathit{DVIN}\)
</p>

<p>
\[
                   \mathit{demand} = \mathit{DVIN}_i \times \mathit{DEMAND}_{i, t} \text{, or zero if $i$ is not a demand location}
                   \]
</p>

<p>
and
</p>

<p>
\[
                   \mathit{supply} = \mathit{SUPPLY}_{i, t} \text{, or zero if $i$ is not a supply location}
                   \]
</p>

<p>
and
</p>

<p>
\[
                   \mathit{outflow} = \sum_{j\in N(i)}\mathit{FLOW}_{i,j,t}
                   \]
</p>

<p>
and
</p>

<p>
\[
                   \mathit{inflow} = \sum_{j\in N(i)}\mathit{FLOW}_{j,i,t}
                   \]
</p>

<p>
and
</p>

<p>
\[
                   \mathit{losses} = \sum_{j\in N(i)}\mathit{AIN}_{j,i} \times \mathit{LOSS_{i,j}}
                   \]
</p>

<p>
Disregarding insulation and skipping over heat losses for now, we constrain \(u_i = 0\)  for every \(i\).
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./formulation/example-flows.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div></dd>

<dt>Flow requires pipe</dt><dd><p>
Since \(\mathit{AIN}\) is used to contribute pipe fixed costs to the objective, we don't want to allow \(\mathit{AIN}_{i,j} = 0\) unless \(\mathit{FLOW}_{i,j,t}\) = 0 as well.
</p>

<p>
This is done using what's normally called a <i>big-M</i> constraint, which looks like this:
</p>

<p>
\[
     \forall t: \mathit{FLOW}_{i,j,t} \leq \mathit{AIN}_{i,j} \times M_{i,j,t}
     \]
</p>

<p>
Here \(M\) is the big-M in question - it is a number chosen to be a bit bigger than the largest value \(\mathit{FLOW}_{i,j,t}\) would sensibly need to take. In this case it is the appropriate flow upper bound, whose computation is described above.
</p>

<p>
The effect is to ensure that we cannot use the pipe unless we also pay for it!
</p></dd>

<dt>Capacity suffices</dt><dd><p>
The pipe cost consists of fixed and variable parts; \(\mathit{AIN}\) turns the fixed part on and off, and \(\mathit{CAPACITY}\) controls the variable part. Without being forced otherwise, the optimiser would set \(\mathit{CAPACITY}\) to 0, so a bit like the previous constraint we need to make sure that if there is a flow, then there is capacity for that flow. 
</p>

<p>
However, since the \(\mathit{FLOW}\) variable reflects the sum of all demands 'down the pipe' without accounting for diversity, we need to introduce a <i>diversity factor</i>, whose mysterious origins will be described later. For now it is sufficient to know that it's a number less than or equal to 1, which makes the required pipe smaller if it is carrying many demands at peak.
</p>

<p>
\[
     \forall t: \mathit{CAPACITY}_{i,j} \geq \mathit{DIVERSITY}_{i,j,t} \times \mathit{FLOW}_{i,j,t}
     \]
</p>

<p>
and also (because capacity is about an <i>edge</i>, but flow is about an <i>arc</i>)
</p>

<p>
\[
     \forall t: \mathit{CAPACITY}_{i,j} \geq \mathit{DIVERSITY}_{j,i,t} \times \mathit{FLOW}_{j,i,t}
     \]
</p></dd>

<dt>Flow one way</dt><dd><p>
To prevent the model putting a pipe on a path in both the forward and reverse directions we say:
</p>

<p>
\[
                  \mathit{AIN}_{i,j} + \mathit{AIN}_{j, i} \leq 1
                  \]
</p></dd>

<dt>Supply capacity suffices</dt><dd><p>
To ensure we purchase enough supply capacity we say
</p>

<p>
\[
     \forall i, t : \mathit{SUPPLYCAPACITY}_i \geq \mathit{DIVERSITY}_{i,t} \times \mathit{SUPPPLY}_{i,t}
     \]
</p>

<p>
Again, diversity is a parameter whose computation is described later; here it is enough to presume that we already know the diversity, even though its value does depend on what the supply has been connected to.
</p></dd>

<dt>Supply requires plant</dt><dd><p>
To ensure we pay the fixed cost for a supply, we say:
</p>

<p>
\[
     \forall i, t : \mathit{SUPPLY}_{i,t} \leq \mathit{SVIN}_i \times M_{i, t}
     \]
</p>

<p>
Where \(M\) is another big-M constraint determined when computing the flow bounds; it is the maximum flow the supply could ever have to produce.
</p></dd>
</dl>
</div>
</div>

<div id="outline-container-orgbd9a0d0" class="outline-3">
<h3 id="orgbd9a0d0"><span class="section-number-3">3.3</span> Insulation</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Each demand location may potentially have some amount of insulation installed.
For the purposes of formulating the MILP, insulation is characterised by a few bits of information:
</p>

<dl class="org-dl">
<dt>Fixed cost</dt><dd>This is the present cost of doing any amount of the insulation</dd>
<dt>Variable cost</dt><dd>This is the present cost per kWh of insulation done</dd>
<dt>Maximum kWh</dt><dd>This is the maximum reduction in demand available</dd>
</dl>

<p>
Then to represent the use of insulation we need to introduce two decision variables
</p>

<ul class="org-ul">
<li>\(\mathit{INSULATION}_{i, t}\), a binary variable to indicate whether insulation of type \(t\) is being installed in demand \(i\).</li>
<li>\(\mathit{INSULATIONKWH}_{i, t}\), a continuous variable indicating how much of insulation \(t\) is installed at demand \(i\).</li>
</ul>

<p>
These naturally produce an extra cost term for the objective:
</p>

<p>
\[
\sum_{i, t} \mathit{INSULATION}_{i,t} \times \text{fixed cost of $t$ at $i$} + \mathit{INSULATIONKWH}_{i, t} \times \text{cost/kwh of $t$ at $i$}
\]
</p>

<p>
As above, we also need a big-M constraint to ensure we pay the fixed cost:
</p>

<p>
\[
\forall i, t : \mathit{INSULATIONKWH}_{i,t} \leq \mathit{INSULATION}_{i,t} \times M
\]
</p>

<p>
Finally we need to make insulation affect the demand for heat. 
Earlier, we said that the unmet demand at each vertex had to be zero; when considering insulation we instead say:
</p>

<p>
\[
0 \leq u_i \leq \sum_t \mathit{INSULATIONKWH}_{i,t}
\]
</p>

<p>
You may wonder why this is not expressed with less slack, as
</p>

<p>
\[
u_i = \sum_t \mathit{INSULATIONKWH}_{i,t}
\]
</p>

<p>
This is because this couples with the flow balance constraint and has the effect that insulation can only be installed if the building is also on the network. This could be fixed by including non-network systems in the flow balance equation, but that creates another problem, that heat from individual systems should not be able to be put <i>into</i> a heat network.
</p>

<p>
The slack here does create a possible odd outcome, where the model buys insulation but does not use it. For example, if insulation had a negative cost, installing it would create value, but not using it would preserve the associated revenue from selling heat. However, under normal combinations of parameters the optimiser will only want to buy insulation when it's going to use it, so this situation doesn't occur.
</p>
</div>
</div>

<div id="outline-container-org1aa4c50" class="outline-3">
<h3 id="org1aa4c50"><span class="section-number-3">3.4</span> Individual systems</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Individual systems (called <i>alternatives</i> in the code) are handled separately from the network model. The use of an individual system to heat a demand location is represented by a single binary decision variable \(\mathit{ALTIN}_{i, t}\) (where \(i \in \mathit{DVTX}\) and \(t \in \mathit{ALT}\)).
</p>

<p>
This variable is constrained so that \(\mathit{ALTIN}_{i, t}\) can only be 1 for demand location / individual system pairs that the user has marked as legal in the inputs.
</p>

<p>
The only other constraint applied is then that
</p>

<p>
\[
  1 = \mathit{DVIN}_i + \sum_t \mathit{ALTIN}_{i,t}
\]
</p>

<p>
This constraint is relaxed for buildings that are not marked as required and have no allowed individual systems; this is arguably a quirk of the user interface, but it allows the user to express questions in which they are uninterested in considering the ins and outs of individual systems.
</p>

<p>
The cost of individual systems is mostly similar to the cost of heat network supply; however, costs related to the heating system's annual output need to reflect the effect of insulation. Since the quantity of insulation is itself a decision variable, we cannot multiply it by \(\mathit{ALTIN}\) without making a quadratic program, so the demand reduction effect is achieved by adding some constraints and another variable:
</p>

<p>
We say that \(\mathit{ALTAVOID}_{i,t}\) is the amount of alternative system \(t\)'s <i>output</i> that we are going to <i>avoid</i> using insulation at demand \(i\). This has to be less than the amount of insulation installed there:
</p>

<p>
\[
\forall i, t:  \mathit{ALTAVOID}_{i, t} \leq \sum_{k \in \mathit{INS}} \mathit{INSULATIONKWH}_{i,k}
\]
</p>

<p>
and we also can't avoid demand in system \(t\) unless we are actually using system \(t\):
</p>

<p>
\[
\forall i, t:  \mathit{ALTAVOID}_{i, t} \leq \mathit{ALTIN}_{i,t} \times M
\]
</p>

<p>
Now we can phrase the cost of alternative systems as:
</p>

<p>
\[
\sum_{i, t} \mathit{ALTIN}_{i, t} \times \text{base present cost} - \mathit{ALTAVOID}_{i, t} \times \text{unit present cost} 
\]
</p>

<p>
where the base present cost reflects is the discounted sum of fixed capital cost, variable capital cost, and unit rate multiplied with the demand <i>before insulation</i>, which we know up-front.
</p>

<p>
Like the slack in the unmet demand constraint, this does allow a situation in which the model purchases insulation but chooses not to use its effect, but again this should be ruled out by sensible sensible parameters (i.e. nonnegative financial costs).
</p>
</div>
</div>
</div>

<div id="outline-container-org6e117cb" class="outline-2">
<h2 id="org6e117cb"><span class="section-number-2">4</span> Parameter updates</h2>
<div class="outline-text-2" id="text-4">
<p>
In the formalism above there are two sets of parameters &#x2013; constants, from the point of view of the MILP &#x2013; which we have referred to but not explained. 
</p>

<p>
These are \(\mathit{LOSSES}\) and \(\mathit{DIVERSITY}\), which represent for each edge in the problem the typical heat losses from a pipe on that edge and the diversity factor for that edge which let us use a smaller pipe than the sum of flows would imply.
</p>

<p>
As far as we know these values cannot be expressed within the optimisation problem without either making it very non-linear (perhaps quadratic) or adding a very large number of additional binary variables and complex constraints.
</p>

<p>
Instead of doing one of these, in THERMOS we try to iteratively approximate these values by:
</p>

<ol class="org-ol">
<li>Making an initial guess for each edge</li>
<li>Solving the resulting MILP</li>
<li>Using the solution to produce a better guess</li>
<li>Updating the MILP with these new guesses, and then going back to step 2.</li>
</ol>

<p>
We stop this process if the solution stops changing, or if we find that we are in a cycle (so guess X gives solution A which leads to guess Y, which gives solution B, which leads back to guess X again).
</p>
</div>

<div id="outline-container-org192093f" class="outline-3">
<h3 id="org192093f"><span class="section-number-3">4.1</span> Finding diversity factors</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The diversity (or perhaps more properly coincidence) factor for a pipe in THERMOS is calculated using the rule:
</p>

<p>
\[
f(n) = 0.62 + 0.38/n
\]
</p>

<p>
So if the pipe is meeting \(n\) demands whose peaks sum to \(d\) the pipe capacity required is taken to be \(f(n) \times d\).
</p>

<p>
Given a candidate solution, we work out a value of \(n\) for each edge by traversing the proposed network from the supply location and counting up how many demands can reached through each edge.
</p>
</div>

<div id="outline-container-orge44a867" class="outline-4">
<h4 id="orge44a867"><span class="section-number-4">4.1.1</span> Preventing invalid configurations</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
The diversity factor rule is slightly too simple, as it allows an incoherent outcome: consider a Y-shaped junction in a network, with the forks of the Y each feeding a single demand, and the stem being the pipe to/from the supply.
</p>

<p>
If one of the two demands is much larger than the other, then the diversified capacity for the combined pipe will be <i>less</i> than the peak capacity for the larger demand's pipe. This is an invalid result - a larger capacity pipe cannot usefully input into a smaller capacity one.
</p>

<p>
To prevent this happening, we also determine for each pipe the maximum peak demand of any of the buildings reachable through it. If the simple diversity rule above would result in a capacity below this maximum, then the pipe is sized for the maximum instead.
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./img/formulation/bad-diversity.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>
</div>
</div>

<div id="outline-container-orged4a0cc" class="outline-4">
<h4 id="orged4a0cc"><span class="section-number-4">4.1.2</span> Initial diversity factors</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
Since the choice of diversity factor depends on having a solution, we must choose some initial diversity values to parameterise the MILP before we have found any solution. We start with the most <i>optimistic</i> diversity value, which is the maximum that could happen in any solution; this is to help the optimiser avoid ruling out the use of a pipe which would be a good choice when allowing for diversity.
</p>
</div>
</div>
</div>

<div id="outline-container-org2080e4f" class="outline-3">
<h3 id="org2080e4f"><span class="section-number-3">4.2</span> Finding heat losses</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Like diversity, heat losses cannot be calculated within the optimisation and so are computed afterwards. The heat loss for each pipe is determined from the pipe's required capacity, indirectly from a model fitted between pipe diameter and heat loss rate.
</p>
</div>

<div id="outline-container-org82b5da4" class="outline-4">
<h4 id="org82b5da4"><span class="section-number-4">4.2.1</span> Initial heat losses</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
The heat losses for each pipe are initialized to the lowest values implied by the lower bound on the power the pipe might deliver if it were used in the network. This is the most optimistic assumption.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org3378a3d" class="outline-2">
<h2 id="org3378a3d"><span class="section-number-2">5</span> Solution re-evaluation</h2>
<div class="outline-text-2" id="text-5">
<p>
Once the iteration described earlier is finished, we take the best solution seen so far, fix its parameters to reflect proper diversity and heat loss values, and then re-solve it with all the binary decision variables constrained so that the solution does not change. This solution is the solution used as the result.
</p>

<p>
This could be improved slightly by doing this to every solution considered, and taking the best under those circumstances.
</p>
</div>
</div>

<div id="outline-container-org1f730a8" class="outline-2">
<h2 id="org1f730a8"><span class="section-number-2">6</span> Choices of objective</h2>
<div class="outline-text-2" id="text-6">
<p>
The application user interface displays two choices of objective, <i>network NPV</i> and <i>whole-system NPV</i>.
</p>

<p>
These two objectives are implemented in the same way as far as the optimisation is concerned, and changing the objective merely changes how the cost parameters for the optimisation are determined.
</p>

<p>
In <i>network NPV</i> mode, the objective is:
</p>

<ul class="org-ul">
<li>The sum of the present value of all connections, less</li>
<li>The present costs for capital and operating expenditures in the network, and</li>
<li>The present cost for emissions by the network supply</li>
</ul>

<p>
In <i>whole-system NPV</i> mode, the objective is:
</p>

<ul class="org-ul">
<li>The sum of the present costs for capital and operating expenditures within <i>and outside</i> the network, and</li>
<li>The present cost for emissions by network supply <i>and individual systems</i></li>
</ul>

<p>
In whole-system mode, the revenues to the network operator are not considered, as these are internal to the system boundary.
</p>
</div>

<div id="outline-container-orgd6d12c1" class="outline-3">
<h3 id="orgd6d12c1"><span class="section-number-3">6.1</span> Market tariff</h3>
<div class="outline-text-3" id="text-6-1">
<p>
In network NPV mode, the astute reader may notice something unfair: if you set an emissions cost, the network has to pay it for anyone that it supplies.
However the network may still be <i>better</i> (e.g. lower carbon) than the alternatives, so it should be receiving some credit for the improvement, rather than just a cost.
</p>

<p>
To handle this discrepancy the model has a special <i>market tariff</i>. If a building is put on this tariff, then the price it would pay for heat from the network is calculated to <i>beat</i> the price it would pay otherwise. This price is determined by:
</p>

<ul class="org-ul">
<li>The options for individual systems and insulation for the building</li>
<li>Emissions prices</li>
<li>A discount rate, period, and a parameter we have called <i>stickiness</i></li>
</ul>

<p>
We work out the market rate by computing the minimum present cost non-networked option the building has (using the discount rate and period for the market tariff - this can differ from that for the optimisation, because it is modelling consumer behaviour rather than what we want to optimise). 
</p>

<p>
Given this minimum present cost, we then reduce it by the stickiness (so for a 10% stickiness, we have 90% of the minimum present cost), and calculate a unit rate for heat in the building where the present cost to the building of that heat would equal this reduced value. If you want to see this as a formula it is something like
</p>

<p>
\[
C = \min_{a \in \text{alternatives}, i \in 2^\text{insulation}} \mathit{PC}(a, i)
\]
</p>

<p>
and then finding \(u\) so that
</p>

<p>
\[
\mathit{PC}(\text{annual cost of $u \times $ demand}) = \text{stickiness} \times C
\]
</p>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
See <a href="https://en.wikipedia.org/wiki/Linear_programming#Integer_unknowns">https://en.wikipedia.org/wiki/Linear_programming#Integer_unknowns</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
Monotonically increasing (where an increase is worse) nonlinear functions generally have efficient linear approximations, because a linear program given a piecewise linear approximation will 'use up' the lower (and hence better) pieces before it uses up the worse ones.
</p>

<p class="footpara">
Decreasing functions can only be piecewise approximated using more complicated gadgets, because some constraints and extra integer variables are needed to prevent the solution taking 'economies of scale' from the curve when it hasn't gone to the scale needed.
</p></div></div>


</div>
</div></div>
</body>
</html>
